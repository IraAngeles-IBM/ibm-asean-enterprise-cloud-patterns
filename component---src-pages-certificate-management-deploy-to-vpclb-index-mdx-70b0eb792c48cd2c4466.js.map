{"version":3,"sources":["webpack:///./src/pages/certificate-management/deploy-to-vpclb/index.mdx"],"names":["_frontmatter","makeShortcode","name","props","console","warn","PageDescription","AnchorLinks","AnchorLink","InlineNotification","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","parentName","small","isMDXComponent"],"mappings":"yeAMO,IAAMA,EAAe,GAEtBC,EAAgB,SAAAC,GAAI,OAAI,SAA6BC,GAEzD,OADAC,QAAQC,KAAK,aAAeH,EAAO,2EAC5B,kBAASC,KAGZG,EAAkBL,EAAc,mBAChCM,EAAcN,EAAc,eAC5BO,EAAaP,EAAc,cAC3BQ,EAAqBR,EAAc,sBACnCS,EAAc,CAClBV,gBAEIW,EAAYC,IACH,SAASC,EAAT,GAGZ,IAFDC,EAEC,EAFDA,WACGX,E,oIACF,mBACD,OAAO,YAACQ,EAAD,KAAeD,EAAiBP,EAAhC,CAAuCW,WAAYA,EAAYC,QAAQ,cAa5E,YAACT,EAAD,CAAiBS,QAAQ,mBACvB,sEAEF,ySACA,4EAA2D,mBAAGC,WAAW,KAAQ,CAC7E,KAAQ,0CAD+C,iBAA3D,qCAEgE,mBAAGA,WAAW,KAAQ,CAClF,KAAQ,2BADoD,eAFhE,4EAKA,6GAA4F,mBAAGA,WAAW,KAAQ,CAC9G,KAAQ,sDADgF,qDAA5F,qBAEoF,mBAAGA,WAAW,KAAQ,CACtG,KAAQ,qHADwE,mDAFpF,KAKA,YAACT,EAAD,CAAaU,OAAK,EAACF,QAAQ,eAC7B,YAACP,EAAD,CAAYO,QAAQ,cAApB,8CACA,YAACP,EAAD,CAAYO,QAAQ,cAApB,aAEE,YAACN,EAAD,CAAoBM,QAAQ,sBAC1B,qBAAG,sBAAQC,WAAW,KAAnB,iBACH,gHAA+F,sBAAQA,WAAW,KAAnB,qBAA/F,wCAA6L,mBAAGA,WAAW,KAAQ,CAC/M,KAAQ,oFADiL,yBAA7L,cAGA,wLACA,0FAAyE,mBAAGA,WAAW,KAAQ,CAC3F,KAAQ,2BAD6D,qBAAzE,2GAE0I,0BAAYA,WAAW,KAAvB,cAF1I,sFAIF,oEACA,8FAA6E,mBAAGA,WAAW,KAAQ,CAC/F,KAAQ,uGADiE,gCAA7E,gUAGA,6PAA4O,0BAAYA,WAAW,KAAvB,UAA5O,oJACA,sCAAqB,0BAAYA,WAAW,KAAvB,+CAArB,6DACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,0DAIL,sCAAqB,0BAAYA,WAAW,KAAvB,mDAArB,gDAAiK,0BAAYA,WAAW,KAAvB,UAAjK,UACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,mEAIL,wDAAuC,0BAAYA,WAAW,KAAvB,UAAvC,yBACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,eACb,WAAc,kBACd,SAAY,WAHX,k/BAgCL,4KACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,+EAIL,0IACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,wDAML,mHACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,oTAaL,oOACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,+FAQL,kCACA,+FACA,uBAAK,sBAAMA,WAAW,OAAU,CAC5B,UAAa,kBADZ,wBAIL,8OAKJH,EAAWK,gBAAiB","file":"component---src-pages-certificate-management-deploy-to-vpclb-index-mdx-70b0eb792c48cd2c4466.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/isaias/Documents/Projects/Developer_Advocate_Group/CODE_PATTERNS/ibm-asean-enterprise-cloud-patterns/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst PageDescription = makeShortcode(\"PageDescription\");\nconst AnchorLinks = makeShortcode(\"AnchorLinks\");\nconst AnchorLink = makeShortcode(\"AnchorLink\");\nconst InlineNotification = makeShortcode(\"InlineNotification\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    {\n      /*\n      The pattern to document the resources is like follow:\n      - Introduce the resource with an example\n      - List all or the most important input parameters\n      - If will be used, list the most important output parameters\n      - Provide instructions to get the value of the input parameters, either using `ibmcloud`, API or the Web console.\n      - If needed, instructions to execute the code either with Terraform or Schematics\n      */\n    }\n    <PageDescription mdxType=\"PageDescription\">\n      <p>{`Deploying certificates to VPC Load Balancers`}</p>\n    </PageDescription>\n    <p>{`The Certificate Manager service provides support for deploying certificates to multiple IBM Cloud services. This section reviews how to configure access from the VPC Load Balancer service to the Certificate Manager service and add an HTTPS listener to a VPC Load Balancer.`}</p>\n    <p>{`The example will use the certificate ordered in the `}<a parentName=\"p\" {...{\n        \"href\": \"/certificate-management/service-setup\"\n      }}>{`service setup`}</a>{` section. The terraform code from `}<a parentName=\"p\" {...{\n        \"href\": \"/iac-resources/compute\"\n      }}>{`IaC compute`}</a>{` will be used to create the vpc, application and load balancer instance.`}</p>\n    <p>{`The code to manage the creation of the example can be found in the GitHub repository `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/IBM/cloud-enterprise-examples/\"\n      }}>{`https://github.com/IBM/cloud-enterprise-examples/`}</a>{` in the directory `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/IBM/cloud-enterprise-examples/tree/master/iac/14-certificate-management/vpc-lbaas-certificate\"\n      }}>{`14-certificate-management/vpc-lbaas-certificate`}</a>{`.`}</p>\n    <AnchorLinks small mdxType=\"AnchorLinks\">\n  <AnchorLink mdxType=\"AnchorLink\">Configure VPC Load Balancer HTTPS listener</AnchorLink>\n  <AnchorLink mdxType=\"AnchorLink\">Clean Up</AnchorLink>\n    </AnchorLinks>\n    <InlineNotification mdxType=\"InlineNotification\">\n      <p><strong parentName=\"p\">{`Requirements`}</strong></p>\n      <p>{`To be able to execute and complete the instructions in this page, make sure you have an `}<strong parentName=\"p\">{`IBM Cloud account`}</strong>{`: if you don’t have one yet, you can `}<a parentName=\"p\" {...{\n          \"href\": \"https://cloud.ibm.com/docs/overview?topic=overview-quickstart_lite#prereqs-lite\"\n        }}>{`create a Lite account`}</a>{` for free.`}</p>\n      <p>{`These examples will require an internet DNS domain that is managed by the user or can be used with a domain managed by the IBM Cloud Internet Services service.`}</p>\n      <p>{`Also make sure you have the environment setup as explained in the `}<a parentName=\"p\" {...{\n          \"href\": \"/iac/setup-environment\"\n        }}>{`Setup Environment`}</a>{` page to have installed the IBM Cloud CLI, logged in to your account with the IBM Cloud CLI and set the `}<inlineCode parentName=\"p\">{`IC_API_KEY`}</inlineCode>{` environment variable to a key which has the ability to manage IAM configuration.`}</p>\n    </InlineNotification>\n    <h2>{`Configure VPC Load Balancer HTTPS listener`}</h2>\n    <p>{`The VPC Load Balancer service can terminate and offload processing of `}<a parentName=\"p\" {...{\n        \"href\": \"https://cloud.ibm.com/docs/vpc?topic=vpc-load-balancers#ssl-offloading-and-required-authorizations\"\n      }}>{`incoming SSL/TLS connections`}</a>{`. In order to do this, a front-end listener pool is defined using the HTTPS protocol and the CRN of the desired certificate in the Certificate Manager. Access to the certificate and the associated private key requires a service authorization between the VPC Load Balancer service and the Certificate Manager service.`}</p>\n    <p>{`These actions can be performed from the web UI, or the IBM Cloud CLI, but in keeping with the example code that is being extended, terraform code to provide the service authorization and listener pool creation is provided in the `}<inlineCode parentName=\"p\">{`tls.tf`}</inlineCode>{` file. This file has a placeholder for the CRN of the certificate to be used by the front-end listener. Update the placeholder with these steps.`}</p>\n    <p>{`Change to the `}<inlineCode parentName=\"p\">{`14-certificate-management/order-certificate`}</inlineCode>{` directory and obtain the CRN of the ordered certificate:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`CERT_CRN=$(terraform output ordered-certificate-id)\n`}</code></pre>\n    <p>{`Change to the `}<inlineCode parentName=\"p\">{`14-certificate-management/vpc-lbaas-certificate`}</inlineCode>{` directory and update the placeholder in the `}<inlineCode parentName=\"p\">{`tls.tf`}</inlineCode>{` file.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`sed -i.bak \"s|CERT-CRN|\\${CERT_CRN}|\" tls.tf && rm tls.tf.bak\n`}</code></pre>\n    <p>{`After running this command, the `}<inlineCode parentName=\"p\">{`tls.tf`}</inlineCode>{` file will look like:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-hcl\",\n        \"metastring\": \"pathname=tls.tf\",\n        \"pathname\": \"tls.tf\"\n      }}>{`data \"ibm_resource_instance\" \"cm\" {\n    name     = \"iac-certificate-manager\"\n    service  = \"cloudcerts\"\n}\n\nvariable \"certificate_crn\" {\n    default = \"crn:v1:bluemix:public:cloudcerts:us-south:a/06788ee4fd5a4d779f236bbe43f09b4b:d6cad342-cf54-49d3-b5f9-42e842e43c40:certificate:df56720b1dab1db089f73d0fd8d6ad20\"\n}\n\nresource \"ibm_iam_authorization_policy\" \"policy\" {\n  source_service_name           = \"is\"  \n  source_resource_type          = \"load-balancer\"\n  target_service_name           = \"cloudcerts\"\n  roles                          = [\"Writer\"]\n}\n\nresource \"ibm_is_lb_listener\" \"iac_app_lb_listener_tls\" {\n  lb                        = ibm_is_lb.iac_app_lb.id\n  port                      = \"443\"\n  protocol                  = \"https\"\n  certificate_instance      = var.certificate_crn\n  default_pool              = ibm_is_lb_pool.iac_app_lb_pool.id\n}\n\noutput \"load_balancer_host_status\" {\n  value = \"add the host \\${ibm_is_lb.iac_app_lb.hostname} as CNAME to the tls host\"\n}\n`}</code></pre>\n    <p>{`Use this command from the IaC Compute section to add the public key used for SSH connections to the folder for use during the environment creation.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`echo \"public_key = \\\\\"$(cat ~/.ssh/id_rsa.pub)\\\\\"\" > secrets.auto.tfvars\n`}</code></pre>\n    <p>{`Now use terraform to create the environment with compute, load balancer and the HTTPS enabled front-end listener.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`terraform init \nterraform plan \nterraform apply\n`}</code></pre>\n    <p>{`When the code completes, a message will appear with the hostname of the VPC Load Balancer:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-text\"\n      }}>{`Apply complete! Resources: 29 added, 0 changed, 0 destroyed.\n\nOutputs:\n\nentrypoint = http://8f962775-us-south.lb.appdomain.cloud:8080\nlb_ip_address = [\n  \"52.116.196.98\",\n  \"52.117.1.76\",\n]\nload_balancer_host_status = add the host 8f962775-us-south.lb.appdomain.cloud as CNAME to the tls host\n`}</code></pre>\n    <p>{` Update the DNS domain name entry in the certificate with a CNAME record that direct to the hostname of the VPC Load Balancer. Once the CNAME is in place, you can access the deployed example application.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`curl https://movies.timro.us/movies/675\n{\n  \"id\": \"675\",\n  \"title\": \"Kagemusha\",\n...\n`}</code></pre>\n    <h2>{`Clean up`}</h2>\n    <p>{`To cleanup all the resources created by the script, run the following:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-bash\"\n      }}>{`terraform destroy\n`}</code></pre>\n    <p>{`This will not delete the Certificate Manager instance or the imported or ordered certificates. Only delete the certificate manager instance if you will not be completing the “Certificates for Kubernetes” example.`}</p>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}