(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{nsVC:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return c})),n.d(t,"default",(function(){return h}));n("91GP"),n("rGqo"),n("yt8O"),n("Btvt"),n("RW0V"),n("q1tI");var a=n("7ljp"),r=n("013z");n("qKvR");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}var c={},s=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(a.b)("div",t)}},o=s("PageDescription"),l=s("AnchorLinks"),p=s("AnchorLink"),b=s("InlineNotification"),m={_frontmatter:c},u=r.a;function h(e){var t=e.components,n=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,["components"]);return Object(a.b)(u,i({},m,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)(o,{mdxType:"PageDescription"},Object(a.b)("p",null,"Deploying certificates to IBM Kubernetes Clusters")),Object(a.b)("p",null,"The Certificate Manager service provides support for deploying certificates to multiple IBM Cloud services. This section reviews how to deploy certificates as secrets to Kubernetes and OpenShift clusters and use them with Kubernetes ingress resources."),Object(a.b)("p",null,"The example will use the certificate imported in the ",Object(a.b)("a",i({parentName:"p"},{href:"/certificate-management/service-setup"}),"service setup")," section. Modified terraform code from ",Object(a.b)("a",i({parentName:"p"},{href:"/iac-resources/container"}),"IaC containers")," will be used to create the kubernetes cluster. The modification reduces the cluster to a single zone with two workers as this is sufficient for demonstrating the custom TLS ingress use case."),Object(a.b)("p",null,"The code to manage the creation of the example can be found in the GitHub repository ",Object(a.b)("a",i({parentName:"p"},{href:"https://github.com/IBM/cloud-enterprise-examples/"}),"https://github.com/IBM/cloud-enterprise-examples/")," in the directory ",Object(a.b)("a",i({parentName:"p"},{href:"https://github.com/IBM/cloud-enterprise-examples/tree/master/iac/14-certificate-management/iks-ingress-certificate"}),"14-certificate-management/iks-ingress-certificate"),"."),Object(a.b)(l,{small:!0,mdxType:"AnchorLinks"},Object(a.b)(p,{mdxType:"AnchorLink"},"Create Kubernetes Cluster"),Object(a.b)(p,{mdxType:"AnchorLink"},"Import certificate from Certificate Manager"),Object(a.b)(p,{mdxType:"AnchorLink"},"Deploy example application with custom TLS in ingress"),Object(a.b)(p,{mdxType:"AnchorLink"},"Clean up")),Object(a.b)(b,{mdxType:"InlineNotification"},Object(a.b)("p",null,Object(a.b)("strong",{parentName:"p"},"Requirements")),Object(a.b)("p",null,"To be able to execute and complete the instructions in this page, make sure you have an ",Object(a.b)("strong",{parentName:"p"},"IBM Cloud account"),": if you donâ€™t have one yet, you can ",Object(a.b)("a",i({parentName:"p"},{href:"https://cloud.ibm.com/docs/overview?topic=overview-quickstart_lite#prereqs-lite"}),"create a Lite account")," for free."),Object(a.b)("p",null,"These examples will require an internet DNS domain that is managed by the user or can be used with a domain managed by the IBM Cloud Internet Services service."),Object(a.b)("p",null,"Also make sure you have the environment setup as explained in the ",Object(a.b)("a",i({parentName:"p"},{href:"/iac/setup-environment"}),"Setup Environment")," page to have installed the IBM Cloud CLI, logged in to your account with the IBM Cloud CLI and set the ",Object(a.b)("inlineCode",{parentName:"p"},"IC_API_KEY")," environment variable to a key which has the ability to manage IAM configuration.")),Object(a.b)("h2",null,"Create Kubernetes Cluster"),Object(a.b)("p",null,"In order to demostrate the use of certificates from the Certificate Manager service in the IBM Kubernetes Service (IKS), a kubernetes cluster with an example application is required. For this guide, the example terraform code to create the cluster and the application deployment resources will be reused from the ",Object(a.b)("a",i({parentName:"p"},{href:"/iac-resources/container"}),"IaC containers")," pattern."),Object(a.b)("p",null,"Before you run through this example, make sure your Terraform environment is setup correctly as documented in the ",Object(a.b)("a",i({parentName:"p"},{href:"/iac/setup-environment"}),"environment setup"),"."),Object(a.b)("p",null,"Change into the ",Object(a.b)("inlineCode",{parentName:"p"},"14-certificate-management/iks-ingress-certificate")," directory and run the following commands to create an IKS cluster."),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"terraform init \nterraform plan \nterraform apply\n")),Object(a.b)("p",null,"A single-zone cluster will be created with two worker nodes. This will take some time as the cluster deploys. When finished the cluster name will be displayed. Set this to an envrionment variable for later use from the command line:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"IKS_CLUSTER=$(terraform output cluster_name)\n")),Object(a.b)("h2",null,"Import certificate from Certificate Manager"),Object(a.b)("p",null,"Deploying certificates from the Certificate Manager service to a kubernetes cluster can be performed from the IBM Cloud CLI using the container service plugin command ",Object(a.b)("a",i({parentName:"p"},{href:"https://cloud.ibm.com/docs/cli?topic=containers-cli-plugin-kubernetes-service-cli#cs_alb_cert_deploy"}),Object(a.b)("inlineCode",{parentName:"a"},"ibmcloud ks alb cert deploy")),"."),Object(a.b)("p",null,"Alternatively, the certificate may also be added using a resource and terraform code. To do this, the CRN of the desired certificate in Certificate Manager is needed. This example will use the certificate that was imported in the Certificate Manager ",Object(a.b)("a",i({parentName:"p"},{href:"/certificate-management/service-setup"}),"service setup"),"."),Object(a.b)("p",null,"Change to the ",Object(a.b)("inlineCode",{parentName:"p"},"14-certificate-management/import-certificate")," directory and obtain the CRN of the ordered certificate:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"cd ../import-certificate\nCERT_CRN=$(terraform output imported-certificate-id)\n")),Object(a.b)("p",null,"Return to the ",Object(a.b)("inlineCode",{parentName:"p"},"14-certificate-management/iks-ingress-certificate")," directory and create a terraform resource file for the tls certificate (the secret in this example is named after the wildcard domain from the imported certificate, it can be changed as desired):"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),'cat > tls.tf <<EOF\nresource ibm_container_alb_cert cert {\n  cert_crn    = "$CERT_CRN"\n  secret_name = "tls-cm-timro-us"\n  cluster_id  = ibm_container_vpc_cluster.iac_iks_cluster.id\n}\nEOF\n')),Object(a.b)("p",null,"Verify and apply the code to add the certificate information as a secret in the IKS cluster:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"terraform plan\nterraform apply\n")),Object(a.b)("p",null,"Verify the secret in the cluster. Configure the kubectl context with access to the IKS cluster using the ",Object(a.b)("inlineCode",{parentName:"p"},"ibmcloud ks cluster config")," command. Then verify the secret in the ",Object(a.b)("inlineCode",{parentName:"p"},"default")," namespace."),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"ibmcloud ks cluster config --cluster $IKS_CLUSTER\nkubectl get secrets -n default\n")),Object(a.b)("p",null,"The secret as named in the ",Object(a.b)("inlineCode",{parentName:"p"},"tls.tf")," file will be shown along with other secrets in the default namespace. The secret created in the ",Object(a.b)("inlineCode",{parentName:"p"},"default")," namespace is a reference to the actual secret which is maintained in the ",Object(a.b)("inlineCode",{parentName:"p"},"ibm-cert-store")," namespace. This secret can be read by ingress resources created in ",Object(a.b)("strong",{parentName:"p"},"any")," namespace of the cluster."),Object(a.b)("h2",null,"Deploy example application with custom TLS in ingress"),Object(a.b)("p",null,"Update the ",Object(a.b)("inlineCode",{parentName:"p"},"kubernetes/deployment.yaml")," resource file to point to the container image that you created in the ",Object(a.b)("a",i({parentName:"p"},{href:"/iac-resources/container"}),"IaC container")," pattern. The actual application used is not important, so if you prefer to use another container image, it is ok to substitute."),Object(a.b)("p",null,"Next, update the ",Object(a.b)("inlineCode",{parentName:"p"},"kubernetes/ingress-tls.yaml")," file with the domain name and tls secret used. Continuing with the example domain used for the Certificate Manager import and the secret as named above, the ingress file would have the following content:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-yaml",metastring:"pathname=ingress-tls.yaml",pathname:"ingress-tls.yaml"}),"apiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: movies-ingress\nspec:\n  tls:\n  - hosts:\n      - movies.cm.timro.us\n    secretName: tls-cm-timro-us\n  rules:\n  - host: movies.cm.timro.us\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: movies\n          servicePort: 80\n")),Object(a.b)("p",null,"For this example scenario, the imported certificate is a wildcard for ",Object(a.b)("inlineCode",{parentName:"p"},"*.cm.timro.us")," allowing any host name to be added to the ",Object(a.b)("inlineCode",{parentName:"p"},"cm.timro.us")," subdomain."),Object(a.b)("p",null,"Create the application deployment, create the service and the ingress with the TLS certificate. The resource files are located in the ",Object(a.b)("inlineCode",{parentName:"p"},"14-certificate-management/iks-ingress-certificate/kubernetes")," directory."),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"cd kubernetes\nkubectl create -f deployment.yaml\nkubectl create -f service.yaml\nkubectl create -f ingress-tls.yaml\n")),Object(a.b)("p",null,"The final step is to configure a CNAME in the DNS for the hostname specified in the ingress that directs the connection to the VPC load balancer for the IKS cluster. Obtain the hostname with:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"kubectl get ingress movies-ingress -o json | jq .status.loadBalancer.ingress[0].hostname\n")),Object(a.b)("p",null,"After the CNAME is added, you will be able to reach the application."),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),'curl https://movies.cm.timro.us/movies/675\n{\n  "id": "675",\n  "title": "Kagemusha",\n...\n')),Object(a.b)("h2",null,"Clean up"),Object(a.b)("p",null,"To cleanup all the resources created by the script, run the following:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),"terraform destroy\n")),Object(a.b)("p",null,"This will not remove the Certificate Manager instance and certificates that have been imported or ordered. If the service is no longer needed, it may be deleted using the IBM Cloud web UI or from the command line:"),Object(a.b)("pre",null,Object(a.b)("code",i({parentName:"pre"},{className:"language-bash"}),'ibmcloud resource service-instance-delete "iac-certificate-manager"\n')))}h.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-certificate-management-deploy-to-iks-index-mdx-8483a7aabbe52f8ff527.js.map